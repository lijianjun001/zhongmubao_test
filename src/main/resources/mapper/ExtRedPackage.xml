<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhongmubao.api.dao.ExtRedPackageDao">

    <select id="getEffectiveExtRedPackageByCustomerIdAndId" resultType="ExtRedPackage">
		select * from ExtRedPackage where
		customerid = #{customerId}
		and id =#{id}
		and expTime>now()
		and isused = 0 limit 1
	</select>

    <insert id="insertExtRedPackage">
		INSERT ignore INTO ExtRedPackage (
		CustomerId,
		Type,
		SheepOrderId,
		IsLock,
		Price,
		IsUsed,
		UsedTime,
		SheepDay,
		ExpTime,
		Modified,
		Created,
		MinSheepCount
		)
		VALUES (
		#{customerId},
		#{type},
		#{sheepOrderId},
		#{isLock},
		#{price},
		#{isUsed},
		#{usedTime},
		#{sheepDay},
		#{expTime},
		#{modified},
		#{created},
		#{minSheepCount}
		)
	</insert>

    <select id="countExtRedPackageByCustomerIdAndBeginTimeAndEndTimeAndType" resultType="int">
		select count(1) from ExtRedPackage where
		type = #{type}
		and created &gt;=#{beginTime}
		and created &lt;=#{endTime} and customerid =#{customerId}
	</select>

    <select id="countExtRedPackageByBeginTimeAndEndTimeAndType" resultType="int">
		select count(1) from ExtRedPackage where
		type = #{type}
		and created >=#{beginTime}
		and created &lt;=#{endTime}
	</select>

    <select id="countLtPriceExtRedPackageByBeginTimeAndEndTimeAndType" resultType="int">
		select count(1) from ExtRedPackage where
		type = #{type}
		and created &gt;=#{beginTime}
		and price &lt;=#{price}
		and created &lt;=#{endTime}
	</select>

    <update id="updateExtRedPackageExpTimeByCustomerIdAndId">
		update ExtRedPackage set exptime = #{expTime} where
		id =#{id}
		and customerid = #{customerId}
	</update>

    <select id="getEffectiveExtRedPackageByCustomerIdAndIds" resultType="ExtRedPackage">
        select * from ExtRedPackage where customerid = #{customerId}
        and expTime>now()
        and isused = 0
        AND IsLock = 0
        and id in
        <foreach collection="ids" item="item" index="index" open="(" close=")" separator=",">
            #{item}
        </foreach>
        order by expTime desc
    </select>

    <update id="updateExtRedPackageIsUsedByCustomerIdAndIds">
        UPDATE ExtRedPackage set IsUsed =1 ,SheepOrderId = -1 where customerid = #{customerId}
        and isused = 0
        AND IsLock = 0
        and id in
        <foreach collection="ids" item="item" index="index" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </update>

    <select id="pageEffectiveExtRedPackageByCustomerIdOrderByType" resultType="ExtRedPackage">
        select * from ExtRedPackage where
        customerid = #{customerId}
        and expTime>now()
        and isused = 0
        AND IsLock = 0
        <choose>
            <when test="type == '03'">
                order by expTime asc
            </when>
            <otherwise>
                order by price desc
            </otherwise>
        </choose>
    </select>

    <select id="getByCustomerIdOrderByType" resultType="ExtRedPackage">
        SELECT * from ExtRedPackage WHERE
        customerid = #{customerId}
        AND expTime>now()
        AND isused = 0
        AND IsLock = 0
        <choose>
            <when test="type == 'ExpTime'">
                order by expTime asc
            </when>
            <otherwise>
                order by price desc
            </otherwise>
        </choose>
    </select>

    <select id="pageEffectiveByCustomerIdAndPrice" resultType="ExtRedPackage">
        SELECT * from ExtRedPackage WHERE
        customerid = #{customerId}
        AND expTime>now()
        AND IsUsed = 0
        AND IsLock = 0
        <choose>
            <when test="price == 0">
                <![CDATA[ AND price<>8 AND price<>5 AND price<>2 AND price<>20 ]]>
            </when>
            <otherwise>
                AND price = #{price}
            </otherwise>
        </choose>
    </select>

    <select id="pageEffectiveByCustomerIdOrderByType" resultType="ExtRedPackage">
        SELECT * from ExtRedPackage WHERE
        customerid = #{customerId}
       <![CDATA[ AND expTime<now()]]>
        AND IsUsed = 0
        AND IsLock = 0
        <choose>
            <when test="type == 'ExpTime'">
                order by expTime desc
            </when>
            <otherwise>
                order by price desc
            </otherwise>
        </choose>
    </select>
</mapper>
